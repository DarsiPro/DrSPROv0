<?php
/**
 * Главный входной скрипт DarsiPro CMS
 *
 * Этот файл является точкой входа для всей системы управления контентом.
 * Он отвечает за инициализацию системы, обработку запросов и маршрутизацию.
 *
 * @project    DarsiPro CMS
 * @author     Петров Евгений <email@mail.ru>
 * @package    Core
 * @url        https://darsi.pro
 * @version    1.0
 * @php        5.6+
 */

// ==============================================
// НАСТРОЙКА ОТОБРАЖЕНИЯ ОШИБОК
// ==============================================

// Включаем отчет обо всех типах ошибок
error_reporting(E_ALL);

// Включаем отображение ошибок в браузере (только для разработки)
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);

// Замер времени начала выполнения скрипта (для отладки)
list($usec, $sec) = explode(" ", microtime());

// Устанавливаем кодировку UTF-8 для всех выходных данных
header('Content-Type: text/html; charset=utf-8');

// ==============================================
// ПРОВЕРКА УСТАНОВКИ СИСТЕМЫ
// ==============================================

/**
 * Проверяем наличие папки install и корректность установки системы.
 * Если папка install существует, но система уже настроена - требуем удалить папку.
 * Если система не установлена - перенаправляем на процесс установки.
 */
if (file_exists('install')) {
    $config = array();
    
    // Проверяем наличие основного конфигурационного файла
    if (file_exists('data/config/__main__.php')) {
        $config = include_once 'data/config/__main__.php';
    }
    
    // Если конфигурация содержит данные о БД, значит система установлена
    if (!empty($config) && !empty($config['__db__']['name'])) {
        die('Before using your site, delete INSTALL directory! <br />Перед использованием удалите папку INSTALL');
    }
    
    // Перенаправляем на установку, если система не настроена
    header('Location: install');
    die();
}

// ==============================================
// ЗАГРУЗКА ЯДРА СИСТЕМЫ
// ==============================================

// Подключаем файл инициализации системы
include_once 'sys/boot.php';

// ==============================================
// ОБРАБОТКА ЗАПРОСА И МАРШРУТИЗАЦИЯ
// ==============================================

/**
 * Парсинг URL и запуск соответствующего модуля
 * 
 * Процесс:
 * 1. Инициируем событие 'before_pather' (до парсинга URL)
 * 2. Создаем экземпляр DrsUrl, который обрабатывает URL и запускает нужный модуль
 * 3. Инициируем событие 'after_pather' (после парсинга URL)
 * 
 * @var $Register Глобальный реестр системы, содержащий настройки и компоненты
 */
Events::init('before_pather', array());
new DrsUrl($Register);
Events::init('after_pather', array());

// ==============================================
// КОНЕЦ ВЫПОЛНЕНИЯ СКРИПТА
// ==============================================
?>